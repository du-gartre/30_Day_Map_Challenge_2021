

# Librerías ---------------------------------------------------------------

library(lubridate)
library(dplyr)



# Importamos la base de datos ---------------------------------------------

# Base completa
df_covid <- read.csv("data/201005COVID19MEXICO.csv")

# Base de Oaxaca, filtrada
covid_oaxaca <- df_covid[which(df_covid$ENTIDAD_RES == "20"), # para seleccionar renglones que cumplan con la cond
                         c(8, 9, 11, 12, 13) ]                 # para seleccionar ciertas columnas

# Dimensiones de la base de Oaxaca
dim(covid_oaxaca)


names(covid_oaxaca)

# Manipulamos la base -----------------------------------------------------

# covid_oaxaca <- todos los casos sde Oaxaca
covid_oaxaca$FECHA_INGRESO      <- as.Date(covid_oaxaca$FECHA_INGRESO)
covid_oaxaca$FECHA_SINTOMAS     <-  as.Date(covid_oaxaca$FECHA_SINTOMAS)
# covid_oaxaca$FECHA_DEF          <- as.Date(covid_oaxaca$FECHA_DEF)

covid_oaxaca_falle <- which(covid_oaxaca$FECHA_DEF != "9999-99-99") # Renglones donde hubo muertos

# Hacemos una selección de los renglones donde solamente hubo muertos
covid_oaxaca_falle2 <- covid_oaxaca[covid_oaxaca_falle, ]

# Base de datos únicamente con los fallecidos de Oaxaca
# covid_oaxaca_falle2 <- todos los fallecidos
covid_oaxaca_falle2$FECHA_DEF  <- as.Date(covid_oaxaca_falle2$FECHA_DEF)


# Tiempo promedio en llegar al hospital
covid_oaxaca$TIEM_SINT_HOSP <- covid_oaxaca$FECHA_INGRESO - covid_oaxaca$FECHA_SINTOMAS

mun_prom_hosp <- aggregate(TIEM_SINT_HOSP ~ MUNICIPIO_RES,
                           data = covid_oaxaca,
                           FUN = mean)[-438, ]

# municipio 999, corresponden a personas que no pudieron mencionar a que municipio pertenecen
# que no pudieron decir ser residentes de algún de un municipio
# p.ej. las personas sin hogar
# Para que me categoricen como residente de un lado, debo verbalizarlo
# esas personas no pudieron decir en qué municipio residen
# ese 999, genera ruido con la base que tengo 

dim(mun_prom_hosp)

# quitamos al municipio 999
mun_prom_hosp <- aggregate(TIEM_SINT_HOSP ~ MUNICIPIO_RES,
                           data = covid_oaxaca,
                           FUN = mean)[-438, ]

# Tiempo promedio en fallecer, dado que se está en el hospital
covid_oaxaca_falle2$TIEM_FALLE_HOSP <- covid_oaxaca_falle2$FECHA_DEF - covid_oaxaca_falle2$FECHA_INGRESO

head(covid_oaxaca_falle2)

mun_prom_falle <- aggregate(TIEM_FALLE_HOSP ~ MUNICIPIO_RES,
                           data = covid_oaxaca_falle2,
                           FUN = mean)
# En este caso, no hay municipio 999

head(mun_prom_hosp)
tail(mun_prom_hosp)
dim(mun_prom_hosp)


# Unir bases de datos -----------------------------------------------------

# buscamos rellenar de NA's los municipios que no están representados en la base de datos

# número de municipios en Oaxaca
lista_mun <- seq(1, 570)

# data frame falso
falso <- data.frame(Muni = lista_mun)

# Unimos los datos de todos los casos de covid
full_sint_hosp2 <- base::merge(x = falso, 
                            y = mun_prom_hosp, 
                            by.x = "Muni", 
                            by.y = "MUNICIPIO_RES",
                            all.x = TRUE)

# Unimos los datos de todos los fallecidos de covid
full_hosp_falle2 <- base::merge(x = falso, 
                               y = mun_prom_falle, 
                               by.x = "Muni", 
                               by.y = "MUNICIPIO_RES",
                               all.x = TRUE)

# Una alternativa para el MERGE
muni_si <- which((lista_mun %in% mun_prom_hosp$MUNICIPIO_RES) != FALSE)
falso <- rep(NA, 570)
falso[muni_si] <- mun_prom_hosp$TIEM_SINT_HOSP


library(rgdal)
library(leaflet)

oax <- readOGR("maps", "oaxaca", encoding = "UTF-8")

oax$NOMGEO

leaflet(data = oax) %>% 
        addTiles() %>% 
        addPolygons(label = ~oax$NOMGEO)


oax$hosp_falle <- as.numeric(full_hosp_falle2[as.numeric(oax@data$CVE_MUN), 2])
oax$sint_hosp <- as.numeric(full_sint_hosp2[as.numeric(oax@data$CVE_MUN), 2])

head(oax@data)

write.csv(x = covid_oaxaca, file = "data/covid_oaxaca.csv")


install.packages('rsconnect')


rsconnect::setAccountInfo(name='d-garibay',


library(rsconnect)

rsconnect::deployApp('C:/Users/David/Documents/David/METPOL/3 semestre/Programacion en R/Clases/primera clase/Shini_oax.Rmd')


# Inormación a nivel municipal --------------------------------------------

library(rgdal)
library(leaflet)

readOGR()
zacatecas <- readOGR("maps", "zac_proy_01")

plot(zacatecas)



leaflet(data = zacatecas) %>% 
        addTiles() %>% 
        addPolygons(label = ~zacatecas$NOMGEO)
